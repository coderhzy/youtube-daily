name: åŒºå—é“¾æ¯æ—¥è§‚å¯Ÿ - è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š5ç‚¹è¿è¡Œ (UTCæ—¶é—´21:00å‰ä¸€å¤©)
    - cron: '0 21 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  daily-update:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (WeasyPrintéœ€è¦)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpangoft2-1.0-0 \
            libharfbuzz0b \
            libffi-dev \
            libjpeg-dev \
            libopenjp2-7-dev \
            libcairo2 \
            libgdk-pixbuf2.0-0

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: è¿è¡Œæ¯æ—¥æ–°é—»æŠ“å–ä¸Žç”Ÿæˆ
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_BASE_URL: https://openrouter.ai/api/v1
          OPENROUTER_MODEL: google/gemini-2.5-flash
          GEMINI_IMAGE_MODEL: google/gemini-3-pro-image-preview
          ENABLE_AI_SUMMARY: true
          ENABLE_IMAGE_GENERATION: true
          ENABLE_PDF_GENERATION: true
          ENABLE_EMAIL_SEND: true
          EMAIL_SMTP_SERVER: smtp.qq.com
          EMAIL_SMTP_PORT: 465
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python main.py

      - name: ä¸Šä¼ ç”Ÿæˆçš„æ–‡ä»¶ä¸º Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_number }}
          path: |
            output/*.md
            output/*.pdf
            output/*.zip
            output/images/**/*.png
          retention-days: 30

      - name: æ˜¾ç¤ºè¿è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“Š è¿è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ç”Ÿæˆçš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh output/*.{md,pdf,zip} 2>/dev/null || echo "æ— æ–‡ä»¶"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å›¾ç‰‡æ•°é‡: $(find output/images -name '*.png' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
